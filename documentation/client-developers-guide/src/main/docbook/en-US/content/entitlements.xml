<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd" [
<!ENTITY % CustomDTD SYSTEM "../../../../../../docbook/custom.dtd">
%CustomDTD;
]>
<chapter id="entitlements">
    <title>Entitlements/Data Roles</title>
    <para>Entitlements, also called as Data Roles, are a set of rules and permissions that are defined 
    per VDB that dictate data access (create, read,  update, delete) permissions for the schema defined 
    by the VDB. The use of entitlements are controlled system wide with the property in 
    <code>&lt;jboss-install&gt;/server/&lt;profile&gt;/deploy/teiid/teiid-jboss-beans.xml</code> file
    in bean configuration section of  <code>RuntimeEngineDeployer</code> with property <code>useEntitlements</code>.</para>
    
    <para>Once the entitlements are enabled, the access permissions defined in each VDB will then be enforced by the Teiid Server.
    To process an <code>INSERT</code> statement, the user account requires the following access rights:</para>
    <orderedlist>
        <listitem> <para><code>CREATE</code> - on the Table being inserted into.</para></listitem>
        <listitem> <para><code>CREATE</code> - on every column being inserted on that Table.</para></listitem>
    </orderedlist>   
    
    <para>To process an <code>UPDATE</code> statement, the user account requires the following access rights:</para>
    <orderedlist>
        <listitem> <para><code>UPDATE</code> - on the Table being updated.</para></listitem>
        <listitem> <para><code>UPDATE</code> - on every column being updated on that Table.</para></listitem>
        <listitem> <para><code>READ</code> - on every column referenced in the criteria.</para></listitem>
    </orderedlist>    
    
    <para>To process a <code>DELETE</code> statement, the user account requires the following access rights:</para>
    <orderedlist>
        <listitem> <para><code>DELETE</code> - on the Table being deleted.</para></listitem>
        <listitem> <para><code>READ</code> - on every column referenced in the criteria.</para></listitem>
    </orderedlist>    

    <para>The data roles are defined inside the <code>META-INF/vdb.xml</code> file, f you used Designer to build your VDB. 
    They defined inside the <code>-vdb.xml</code> file defined if you are using the Dynamic VDBs. The below example will show
    a sample "vdb.xml" file with few simple data rules.</para>
    
    <para>For example, if a VDB schema defined a table below in its model files named "modelName"</para>
    
   <programlisting><![CDATA[
       modelName.TableA (
        column1 VARCHAR,
        column2 INT
       )   
   ]]></programlisting>    
    
   <para>and has three (3) users "UserA", "UserB", "UserC" with following permissions</para>
   <orderedlist>
    <listitem><para>UserA has privileges to read, write access to TableA, but can not delete.</para></listitem>
    <listitem><para>UserB has no privileges that allow access to TableA</para></listitem>
    <listitem><para>UserC has privileges that only allow read access to TableA.column1</para></listitem>
   </orderedlist>

    <para>Then the resulting "vdb.xml" file will look like below.</para>
    
   <programlisting><![CDATA[
<?xml version="1.0" encoding="UTF-8"?>
<vdb name="sample" version="1">

    <model name="modelName">
        <source name="source-name" translator-name="oracle" connection-jndi-name="java:myDS" />
    </model>

    <data-policy name="policy-1">
        <description>Allow all, except Delete</description>

        <permission>
            <resource-name>modelName.TableA</resource-name>
            <allow-create />
            <allow-read />
            <allow-update />
        </permission>

        <permission>
            <resource-name>modelName.TableA.colum1</resource-name>
            <allow-create />
            <allow-read />
            <allow-update />
        </permission>

        <permission>
            <resource-name>modelName.TableA.column2</resource-name>
            <allow-create />
            <allow-read />
            <allow-update />
        </permission>

        <mapped-role-name>role1</mapped-role-name>

    </data-policy>

    <data-policy name="policy-2">
        <description>Allow read only</description>

        <permission>
            <resource-name>modelName.TableA</resource-name>
            <allow-read />
        </permission>

        <permission>
            <resource-name>modelName.TableA.colum1</resource-name>
            <allow-read />
        </permission>

        <mapped-role-name>role2</mapped-role-name>
    </data-policy>
</vdb>  
   
   ]]></programlisting>    
   
   <para>The above XML defined two data policies, "policy-1" which allows everything except delete on the table, "policy-2" that 
   allows only read operation on the table. The "mapped-role-name" defines the "role" to whom these policies are applicable. Each data-policy 
   must define a "role" to be enforced by the Teiid Server.</para>
   
   <para>
   The above xml assumes that "UserA" has "role1" role and "UserC" has "role2" role and 
   "UserB" does not have either "role1" or "role2" roles.</para> 
   
   <para>For assigning the roles to your users, in the JBoss AS, 
   check out the instructions for the selected Login Module. Check "Admin Guide" for configuring Login Modules.</para> 
   
   <para>"vdb.xml" file is checked against the schema file <code>vdb-deployer.xsd</code>, check the documents sections of the Teiid kit
   to find a copy of the schema file.</para>
   
   <note><para>Currently there is no GUI tooling support in the Designer or any other management tool to create this data roles 
   permissions xml, however this is in our roadmap for future releases to provide.</para></note>
</chapter>