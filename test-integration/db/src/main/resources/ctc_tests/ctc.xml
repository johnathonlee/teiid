<?xml version="1.0" encoding="UTF-8"?>
<project name="ctc" default="main" >
	
	<property name="root_output" value="${proj.dir}/target/bulk-query-tests" />
	
	<property name="ERROR_FILE" value="${root_output}/ERROR_FOUND.txt" />

	<taskdef resource="net/sf/antcontrib/antlib.xml">
	  <classpath>
	  	<pathelement path="${maven.runtime.classpath}" />
	  </classpath>
	</taskdef>
	
	<target name="main" depends="init" if="" unless="" description="create all property files">
		<antcall target="run.all.test" inheritall="true" />
		<antcall target="run.single.test" inheritall="true" />
		
		<available file="${ERROR_FILE}" property="error.flagged"/>

		<fail if="error.flagged" message="One or more ctc tests failed" />


	</target>


	<target name="init" depends="" >
		
		
		<available file="${scenario.dir}" type="dir" property="dir.exist"/>
		<fail unless="dir.exist" message="Scenario directory ${scenario.dir} does not exist" />

		<!--		
		<pathconvert targetos="unix" property="install_dir" >
           		 <map from="\" to="/"/>
           		<path location="${install.dir}"/>
        	 </pathconvert>
		-->
		
		<condition property="all">
			<not>
				<isset property="single"/>
			</not>
		</condition>
		
		<delete file="${ERROR_FILE}"/>

	</target>

    <target name="run.all.test"
    		if="all" >
    	<echo>Executing ALL Scenarios</echo>
    	
    	<for param="file">
    	  <path>
    	    <fileset dir="${scenario.dir}" includes="*.properties"/>
    	  </path>
    	  <sequential>
    	  	<antcall target="exec.scenario" inheritall="true" >
   				<param name="scenario.file" value="@{file}" />
    	  		<param name="scenario.dir" value="@{file}" />
			</antcall>
	  	
    	  	<!--
    		<antcall target="exec.scenario" inheritall="true" >
    			<param name="scenario.file" value="@{file}" />
			</antcall>
	  	-->
    	  </sequential>
    	</for>
    	
    </target>
	
    <target name="run.single.test"
    		if="single" >
    	<echo>Executing Scenario ${test.scenario}</echo>
		<property name="include.what" value="${scenario.dir}/${scenario.file}" />

        <iterate target="run.scenario"/>
    </target>
	
	<target name="exec.scenario" depends="" >

		
		<echo>Scenario property file ${scenario.file}</echo>
		<!--
		jvm="${java.home}/bin/java"
		-->

          <java classname="org.teiid.test.client.TestClient" fork="true" >
          	<classpath>
        		<pathelement path="${maven.runtime.classpath}" />
                <fileset dir="${proj.dir}/lib">
                  <include name="**/*.jar"/>
                </fileset>
            </classpath>
            <jvmarg value="-Xmx1024m" />
    	    <jvmarg value="-Dmetamatrix.sockets=true" />
          	<jvmarg value="-Dconfig=${config.file}" />
          	<jvmarg value="-Dscenariofile=${scenario.file}" />
          	<jvmarg value="-Dqueryset.artifacts.dir=${queryset.artifacts.dir}" />
        	<jvmarg value="-Dvdb.artifacts.dir=${vdb.artifacts.dir}" />

      	  </java>
		
   	  	 <antcall target="are.there.errors" inheritall="true" />


	</target>
	
	<target name="are.there.errors" >
		<!-- load the scenario file to get the queryset thats being run -->
		<loadproperties srcFile="${scenario.file}" />
		
		
		<!-- get the scenario name based on the scenario file, strip the suffix  -->
		<basename property="scenario.name" file="${scenario.file}"
		          suffix=".properties"/>

		<echo>Are there any files ${root_output}/${queryset.dir}/output/${scenario.name}</echo>
		
	      <path id="output.dir.files">
	                  <fileset dir="${root_output}/${queryset.dir}/output/${scenario.name}">
	                  		<include name="*.txt"/>
	                  </fileset>
	        </path>
		
		<condition property="has.output">
			<resourcecount refid="output.dir.files" when="greater" count="0" />
		</condition>
		<echo>Is there output ${has.output}</echo>

	      <path id="error.files">
	                  <fileset dir="${root_output}/${queryset.dir}/output/${scenario.name}">
	                  		<include name="ERROR*"/>
	                  </fileset>
	        </path>
		
		<condition property="error.files.exist">
			<resourcecount refid="error.files" when="greater" count="0" />

		</condition>
		
		<echo>Do Error files exists ${error.files.exist}</echo>
		
		<condition property="error.exist">
			<not>
				<isset property="has.output"/>
			</not>
		</condition>
		<condition property="error.exist">
				<isset property="error.files.exist"/>
		</condition>

		<echo>Is this considered an error ${error.exist}</echo>
		
		<antcall target="touch.error.file" inheritall="true" />

	</target>

	<target name="touch.error.file"
		if="error.exist">
			<echo>Flag Error - Query Set: ${queryset.dir} Scenario: ${scenario.name} </echo>

		<concat destfile="${ERROR_FILE}" append="true">Query Set: ${queryset.dir} Scenario: ${scenario.name} </concat>

	
	</target>
	

</project>		