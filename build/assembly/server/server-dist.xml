<project default="main" name="Teiid/Build" basedir="../../">
	
	<property name="deploy.dir" value="${basedir}/${relative.artifact.dir}"></property>
	<property name="bin.dir" value="${basedir}/target/distribution/teiid-server-${product.version}-binaries.dir"/>
	<property name="temp.dir" value="${basedir}/target/tmp"/>
	<property name="kit.dir" value="${basedir}/src/kit-server"/>
	<property name="sql.dir" value="${basedir}/src/main/sqlrepository"/>
	
	<target name="main" depends="build-kit-dir,  build-lib-dir, chmod" />
	
	<target name="build-kit-dir" >
		<delete dir="${deploy.dir}"/>
		<copy todir="${deploy.dir}">
			<fileset dir="${kit.dir}"/>
		</copy>
		
		<mkdir dir="${deploy.dir}/log"/>
		<mkdir dir="${deploy.dir}/log/txnlog"/>
		<mkdir dir="${deploy.dir}/data"/>
		<mkdir dir="${deploy.dir}/data/buffer"/>
		<mkdir dir="${deploy.dir}/data/temp"/>
		<mkdir dir="${deploy.dir}/config"/>
		<mkdir dir="${deploy.dir}/docs"/>
		<mkdir dir="${deploy.dir}/lib"/>
		
		<copy todir="${deploy.dir}/config/install/repository-db">
			<fileset dir="${sql.dir}"/>
		</copy>		

		<unzip dest="${deploy.dir}/docs">
			<fileset dir="${bin.dir}">
			  <include name="*-xa-docs.zip"/>
			</fileset>
		</unzip>
	</target>
	
	<target name="build-client-jar" >
		<mkdir dir="${temp.dir}/client"/>
		
		<unjar dest="${temp.dir}/client">
			<fileset dir="${bin.dir}">
			  <include name="teiid-client-*.jar"/>
			  <include name="teiid-common-*.jar"/>
			  <include name="netty-*.jar"/>
			  <include name="jdom-*.jar"/>			  
			</fileset>
		</unjar>
		
		<jar destfile="${deploy.dir}/client/metamatrix-jdbc.jar" basedir="${temp.dir}/client"/>
		<delete dir="${temp.dir}/client"/>
	
	</target>
	
	<target name="build-lib-dir" >		
		<copy todir="${deploy.dir}/lib">
			<fileset dir="${bin.dir}">
				<exclude name="teiid-client-jdbc-*.jar"/>
				<exclude name="teiid-console-*.jar"/>
				<exclude name="*-tests.jar"/>
				<exclude name="*.zip"/>
			</fileset>
		</copy>				
	</target>
	<target name="set.os">
		<condition property="UnixOS">
			<os family="unix"/>   
			</condition>               
			<condition property="WinOS">
			<os family="windows"/>
		</condition>   
	</target>   
	<target name="chmod" depends="set.os"  if="UnixOS">
	    <chmod dir="${deploy.dir}" perm="ugo+rx" includes="**/*.sh"/>   
    </target> 
	
</project>