#!/bin/sh

#
# ##COPYRIGHT##
#
# This will first stop the processes for this host, and then
# stop this hostcontroller.
#
#
# If you ran startserver with the -config or -host parameter, you will need
# to pass the same host name as an argument when running this script
#
# If you only wish to stop the processes on this host and not the hostcontroller,
# run stopserver -processes
#
#

# -----------------------------------------------------------------------------------------
#	stopserver {-config <hostidentifier>} {-processes}
#
#
# Options:
# 
# 		-config <hostidentifier>  The hostidentifier is the name given to this host configuration within the 
#							MetaMatrix Configuration file. If omitted, the fully-qualified 
#							host name is used, derived from InetAddress.  If the value passed 
#							can not be found in the configuration, an attempt is made to resolve
#							it to the physical host name or IP address. 
#
#
#		-processes	- If present, will cause only the processes started by this host to be stopped.
# 
# Examples: stopserver -config 192.254.254.5
# 
#           This command will pass the IP address as the host name for 
#			which must be matched to a host in the configuration.
#            
# 
# -----------------------------------------------------------------------------------------

# resolve links - $0 may be a softlink
LOC="$0"

while [ -h "$LOC" ] ; do
  ls=`ls -ld "$LOC"`
  link=`expr "$ls" : '.*-> \(.*\)$'`
  if expr "$link" : '.*/.*' > /dev/null; then
    LOC="$link"
  else
    LOC=`dirname "$LOC"`/"$link"
  fi
done

LOCDIR=`dirname "$LOC"`
PRGDIR=`cd "$LOCDIR"; pwd`

cd ${PRGDIR}

. ./mmenv.sh

cd ${MM_LOG}

# the call to kill all processes and the hostcontroller
KILLHOST="killHostController"
# the call to kill only the processes for the host
KILLPROCESSES="killHost"

KILLCALL=$KILLHOST
KILLMSG="Stopping hostcontroller"

PARMS=""

if [ $# -gt 3 ] ; then
	echo "stopserver only accepts upto 3 arguments, $# arguments were passed."
	echo "Usage:   stopserver {-config <hostidentifier> } {-processes}"
	exit 1
fi

if [ $# -ge 1 ] ; then
  next=""
  for parm in "$@"
          do
      if [ "$next" != "yes" ] 
         then
             case $parm in
               -config) next="yes"
		          PARMS="$PARMS $parm"
                 ;;
               -processes) KILLCALL="$KILLPROCESSES"
		           KILLMSG="Stopping processes"
                  ;;	
		        *) PARMS="$PARMS $parm"
			             $HOST_PARM=""
			      ;;
		esac			
     else
          PARMS="$PARMS $parm"
          next=""
     fi	
done
	
	# if the <hostname> parm was not passed in, then
	# need to use the default
	if [ ! "${HOST_PARM}" = "" ]
	then
             PARMS="$PARMS $HOST_PARM"
         fi	

fi


echo ${KILLMSG} ${PARMS}

${MM_JAVA} -Xmx128m com.metamatrix.platform.util.MetaMatrixController ${KILLCALL} ${PARMS}


