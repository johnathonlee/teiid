<?xml version="1.0"?>
<!--  Copyright (c) 2008 Varsity Gateway LLC -->
<project name="installer.repository"
                default=""
         basedir=".">

	 <property name="db.scripts.relative.dir"  value="${relative.install.dir}/repository-db/schema" />

	<property name="db.oracle.script"  value="${metamatrix.installationDir}/${db.scripts.relative.dir}/oracle" />
	<property name="db.db2.script"  value="${metamatrix.installationDir}/${db.scripts.relative.dir}/db2" />
	<property name="db.sqlserver.script"  value="${metamatrix.installationDir}/${db.scripts.relative.dir}/sqlserver" />
	<property name="db.sybase.script"  value="${metamatrix.installationDir}/${db.scripts.relative.dir}/sybase" />
	<property name="db.mysql.script"  value="${metamatrix.installationDir}/${db.scripts.relative.dir}/mysql" />
	<property name="db.postgres.script"  value="${metamatrix.installationDir}/${db.scripts.relative.dir}/postgres" />
	<property name="db.derby.script"  value="${metamatrix.installationDir}/${db.scripts.relative.dir}/derby" />


	<property name="data.scripts.relative.dir"  value="${relative.install.dir}/repository-db/data" />


    <taskdef name="dbTypeTask" classname="com.metamatrix.installer.anttask.jdbc.DBTypeTask"/>
           	
    
   <target name="create.schema"    depends="exec.db.type, db2.rdbms, oracle.rdbms, microsoft.rdbms, mysql.rdbms, postgres.rdbms, sybase.rdbms, derby.rdbms"
       description="Execute Schema Create/Drop DDL">
       <echo>Execute Create DDL scripts for user ${user} for RDBMS ${rdbms.type}</echo>
		
  		<antcall target="insert.execute.sql"/>
   </target>
	
	<target name="exec.db.type">
  		 <dbTypeTask    driver="${driver}"
            url="${url}"
            userid="${user}"
            password="${password}"
   		 	databaseTypeProperty="db.type"
  		 /> 	
		<echo>DB TYPE ${db.type}</echo>
        <condition property="oracle" >
            <contains string="${db.type}" substring="oracle" casesensitive="false" />
        </condition> 
        <condition property="db2" >
        	<contains string="${db.type}" substring="db2" casesensitive="false" />        	
        </condition> 
        <condition property="microsoft" >
        	<contains string="${db.type}" substring="microsoft" casesensitive="false" />
        </condition> 
        <condition property="mysql" >
        	<contains string="${db.type}" substring="mysql" casesensitive="false" />
        </condition> 
        <condition property="postgres" >
        	<contains string="${db.type}" substring="postgres" casesensitive="false" />
        </condition> 
        <condition property="sybase" >
        	<contains string="${db.type}" substring="sybase" casesensitive="false" />
        </condition> 
        <condition property="derby" >
        	<contains string="${db.type}" substring="derby" casesensitive="false" />
        </condition> 
			
	</target>
	
	<target name="db2.rdbms" if="db2">
			<property name="rdbms.type" value="db2" />
		<echo>RDBMS ${rdbms.type}</echo>
	  	<antcall target="execute.sql">
			<param name="sql.script.dir" value="${db.db2.script}"/>
			<param name="delim" value="%"/>
			<param name="delimtype" value="normal"/>
	  	</antcall>		
	</target>
	   
	<target name="oracle.rdbms" if="oracle">
			<property name="rdbms.type" value="oracle" />
		<echo>RDBMS ${rdbms.type}</echo>
	 	<antcall target="execute.sql">
			<param name="sql.script.dir" value="${db.oracle.script}"/>
			<param name="delim" value=";"/>
			<param name="delimtype" value="normal"/>
	  	</antcall>
	</target>
	<target name="microsoft.rdbms" if="microsoft">
	   		<property name="rdbms.type" value="microsoft" />
		<echo>RDBMS ${rdbms.type}</echo>
	  	<antcall target="execute.sql">
			<param name="sql.script.dir" value="${db.sqlserver.script}"/>
			<param name="delim" value="GO"/>
			<param name="delimtype" value="row"/>
	  	</antcall>		
	</target>
	<target name="sybase.rdbms" if="sybase">
	   		<property name="rdbms.type" value="oracle" />
		<echo>RDBMS ${rdbms.type}</echo>
	  	<antcall target="execute.sql">
			<param name="sql.script.dir" value="${db.sybase.script}"/>
			<param name="delim" value="GO"/>
			<param name="delimtype" value="row"/>
	  	</antcall>		
	</target>
	<target name="mysql.rdbms" if="mysql">
	   		<property name="rdbms.type" value="mysql" />
		<echo>RDBMS ${rdbms.type}</echo>
	  	<antcall target="execute.sql">
			<param name="sql.script.dir" value="${db.mysql.script}"/>
			<param name="delim" value=";"/>
			<param name="delimtype" value="normal"/>
	  	</antcall>		
	</target>
	<target name="postgres.rdbms" if="postgres">
	    		<property name="rdbms.type" value="oracle" />	    	
		<echo>RDBMS ${rdbms.type}</echo>
	 	<antcall target="execute.sql">
			<param name="sql.script.dir" value="${db.postgres.script}"/>
			<param name="delim" value=";"/>
			<param name="delimtype" value="normal"/>
	  	</antcall>		
	</target>
	<target name="derby.rdbms" if="derby">
	   		<property name="rdbms.type" value="derby" />
		<echo>RDBMS ${rdbms.type}</echo>
	  	<antcall target="execute.sql">
			<param name="sql.script.dir" value="${db.derby.script}"/>
			<param name="delim" value=";"/>
			<param name="delimtype" value="normal"/>
	  	</antcall>		
	</target>
	


    <target name="execute.sql"  > 
		<echo>Trying to execute drop/create for rdbms ${rdbms.type}</echo>
	
	  	<antcall target="execute.java" inheritAll="true" >
			<param name="sql.script" value="${sql.script.dir}/mm_drop.sql" />
	  		<param name="log.file" value="${metamatrix.installationDir}/log/setup_droptables.log" />
	  	</antcall>
	
		 <sql     driver="${driver}"
	                    url="${url}"
	                    userid="${user}"
	                    password="${password}"
	                    src="${sql.script.dir}/mm_create.sql"
	                    rdbms="${rdbms.type}"
		    delimiter="${delim}"
		    delimitertype="${delimtype}"
		    autocommit="true"
		    onerror="abort"    
		 /> 
	
    </target>

    <target name="execute.java" >
    <!--
            Calling ant in the manner was implemented so that the errors generated from the drops scripts (i.e., table doesn't exist) don't get output 
            to the upgrade log, since these errors are not actual errors to the overall process.
            
               <jvmarg value="-verbose" />
    -->
<!-- 
  This echo is here to inform people that when executing the drop sql statements,
	errors may occur, depending on of the table already exist.  
	
	<jvmarg value="-Dlog=${log.file}" />
-->
    	<delete file="${log.file}"/> 
    	
          <java classname="org.apache.tools.ant.Main" fork="true" jvm="${java.home}/bin/java">
            <classpath>
                <pathelement path="${classpath}"/>
            </classpath>
            <jvmarg value="-Xmx256m" />
            <jvmarg value="-Ddriver=${driver}" />
            <jvmarg value="-Durl=${url}" />
            <jvmarg value="-Duserid=${user}" />
            <jvmarg value="-Dpassword=${password}" />
            <jvmarg value="-Dscript=${sql.script}" />
            <jvmarg value="-Drdbms.type=${rdbms.type}" />
	    <jvmarg value="-Ddelim=${delim}" />
	    <jvmarg value="-Ddelimtype=${delimtype}" />
            <arg line="-buildfile ${repository.xml.file}" />
            <arg line=" execute.java.script " />
            <arg line=" -logger org.apache.tools.ant.DefaultLogger " />
            <arg line=" -logfile ${log.file} " /> 
        </java>  
 </target>   
 
  <target name="execute.java.script">
	<echo>===================================================================</echo>
    <echo>NOTE: Any errors associated with this execution is not an error,</echo>
    <echo>processing will continue regardless of success    			</echo>
    <echo>===================================================================</echo>
 	
       		 <sql     driver="${driver}"
                            url="${url}"
                            userid="${userid}"
                            password="${password}"
                            src="${script}"
                            rdbms="${rdbms.type}"
			    delimiter="${delim}"
			    delimitertype="${delimtype}"
			    autocommit="true"
			    onerror="continue" 
       		 /> 

  </target>

 
   <target name="insert.execute.sql"  >
	<echo>Trying to load defaults for rdbms ${rdbms.type}</echo>
       		 <sql     driver="${driver}"
                            url="${url}"
                            userid="${user}"
                            password="${password}"
                            src="${metamatrix.installationDir}/${data.scripts.relative.dir}/data_clear.sql"
                            rdbms="${rdbms.type}"
			    delimiter=";"
			    autocommit="true" 
			    output="${metamatrix.installationDir}/log/setup_loaddefaults.log"
       		 /> 
       		 <sql     driver="${driver}"
                            url="${url}"
                            userid="${user}"
                            password="${password}"
                            src="${metamatrix.installationDir}/${data.scripts.relative.dir}/data_insert.sql"
                            rdbms="${rdbms.type}"
			    delimiter=";"
			    autocommit="true"   
       		 /> 
   </target>

</project>


